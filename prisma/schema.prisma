// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider   = "prisma-client-js"
  previewFeatures = ["driverAdapters"]
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model Etf {
  ticker         String          @id
  name           String
  currency       String
  exchange       String?
  price          Decimal
  daily_change   Decimal
  yield          Decimal?
  mer            Decimal?
  beta5Y         Decimal?
  peRatio        Decimal?
  forwardPe      Decimal?
  fiftyTwoWeekHigh Decimal?
  fiftyTwoWeekLow  Decimal?

  // Extended Metrics
  marketCap        Decimal?
  sharesOut        Decimal?
  eps              Decimal?
  revenue          Decimal?
  netIncome        Decimal?
  dividend         Decimal?
  dividendGrowth5Y Decimal?
  exDividendDate   String?
  volume           Decimal?
  open             Decimal?
  prevClose        Decimal?
  earningsDate     String?
  daysRange        String?
  fiftyTwoWeekRange String?

  // New ETF Metrics
  inceptionDate    String?
  payoutFrequency  String?
  payoutRatio      Decimal?
  holdingsCount    Int?
  bondMaturity     Decimal?
  bondDuration     Decimal?

  assetType      String          @default("ETF")
  isDeepAnalysisLoaded Boolean   @default(false)
  history        EtfHistory[]
  sectors        EtfSector[]
  holdings       Holding[]
  allocation     EtfAllocation?
  portfolioItems PortfolioItem[]
  redditCommunities RedditCommunity[]

  updatedAt      DateTime        @updatedAt
}

model EtfHistory {
  id        Int      @id @default(autoincrement())
  etfId     String
  date      DateTime
  close     Decimal
  interval  String   @default("daily")
  etf       Etf      @relation(fields: [etfId], references: [ticker])

  @@unique([etfId, date, interval])
}

model EtfSector {
  id          Int    @id @default(autoincrement())
  etfId       String
  sector_name String
  weight      Decimal
  etf         Etf    @relation(fields: [etfId], references: [ticker])
}

model Holding {
  id        String   @id @default(cuid())
  etfId     String
  ticker    String
  name      String
  sector    String?
  weight    Decimal
  shares    Decimal?
  etf       Etf    @relation(fields: [etfId], references: [ticker])

  @@index([etfId, ticker])
}

model EtfAllocation {
  id           Int    @id @default(autoincrement())
  etfId        String @unique
  stocks_weight Decimal
  bonds_weight  Decimal
  cash_weight   Decimal
  etf          Etf    @relation(fields: [etfId], references: [ticker])
}

model PortfolioItem {
  id        Int    @id @default(autoincrement())
  userId    String
  etfId     String
  weight    Decimal
  shares    Decimal  @default(0)
  user      User   @relation(fields: [userId], references: [id], onDelete: Cascade)
  etf       Etf    @relation(fields: [etfId], references: [ticker])

  @@unique([userId, etfId])
}

model User {
  id             String          @id @default(cuid())
  name           String?
  email          String?         @unique
  emailVerified  DateTime?
  image          String?
  accounts       Account[]
  sessions       Session[]
  portfolioItems PortfolioItem[]
  createdAt      DateTime        @default(now())
  updatedAt      DateTime        @updatedAt
}

model Account {
  id                String  @id @default(cuid())
  userId            String
  type              String
  provider          String
  providerAccountId String
  refresh_token     String? @db.Text
  access_token      String? @db.Text
  expires_at        Int?
  token_type        String?
  scope             String?
  id_token          String? @db.Text
  session_state     String?

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([provider, providerAccountId])
}

model Session {
  id           String   @id @default(cuid())
  sessionToken String   @unique
  userId       String
  expires      DateTime
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model VerificationToken {
  identifier String
  token      String   @unique
  expires    DateTime

  @@unique([identifier, token])
}

model MarketSentiment {
  id     Int      @id @default(autoincrement())
  date   DateTime @unique
  score  Float
  rating String
}

model RedditCommunity {
  id        String   @id @default(cuid())
  etfId     String
  subreddit String   // e.g., "justbuy", "stocks", "investing"
  url       String?  // Full Reddit URL if available
  etf       Etf      @relation(fields: [etfId], references: [ticker], onDelete: Cascade)

  @@unique([etfId, subreddit])
  @@index([etfId])
}
